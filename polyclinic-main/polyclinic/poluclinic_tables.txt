-- Создание последовательностей (генераторы первичных ключей)
CREATE SEQUENCE user_data_id_seq START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE patient_id_seq START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE doctor_id_seq START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE department_id_seq START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE appointment_id_seq START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE service_id_seq START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE payment_id_seq START WITH 1 INCREMENT BY 1;


-- Таблица пользователей
CREATE TABLE user_data (
    user_id INTEGER PRIMARY KEY DEFAULT nextval('user_data_id_seq'),
    full_name VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    phone VARCHAR(20),
    password VARCHAR(255) NOT NULL,
    is_admin BOOLEAN DEFAULT FALSE
);

-- Таблица отделений
CREATE TABLE department (
    department_id INTEGER PRIMARY KEY DEFAULT nextval('department_id_seq'),
    department_name VARCHAR(100) NOT NULL UNIQUE,
    description TEXT
);

-- Таблица услуг
CREATE TABLE service (
    service_id INTEGER PRIMARY KEY DEFAULT nextval('service_id_seq'),
    department_id INTEGER NOT NULL,
    service_name VARCHAR(100) NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL CHECK (price >= 0),
    FOREIGN KEY (department_id) REFERENCES department(department_id) ON DELETE CASCADE
);

-- Таблица врачей
CREATE TABLE doctor (
    doctor_id INTEGER PRIMARY KEY DEFAULT nextval('doctor_id_seq'),
    user_id INTEGER NOT NULL UNIQUE,
    department_id INTEGER NOT NULL,
    specialization VARCHAR(100) NOT NULL,
    hire_date DATE NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (user_id) REFERENCES user_data(user_id) ON DELETE CASCADE,
    FOREIGN KEY (department_id) REFERENCES department(department_id) ON DELETE RESTRICT
);

-- Таблица пациентов
CREATE TABLE patient (
    patient_id INTEGER PRIMARY KEY DEFAULT nextval('patient_id_seq'),
    user_id INTEGER NOT NULL UNIQUE,
    gender VARCHAR(10) CHECK (gender IN ('Мужской', 'Женский')),
    snils VARCHAR(20) UNIQUE NOT NULL,
    address TEXT NOT NULL,
    FOREIGN KEY (user_id) REFERENCES user_data(user_id) ON DELETE CASCADE
);

-- Таблица записей на прием
CREATE TABLE appointment (
    appointment_id INTEGER PRIMARY KEY DEFAULT nextval('appointment_id_seq'),
    patient_id INTEGER NOT NULL,
    doctor_id INTEGER NOT NULL,
    service_id INTEGER NOT NULL,
    appointment_date TIMESTAMP NOT NULL,
    status VARCHAR(20) CHECK (status IN ('Запланирован', 'Завершен', 'Отменен', 'Перенесен')),
    notes TEXT,
    price DECIMAL(10,2) NOT NULL CHECK (price >= 0),
    FOREIGN KEY (patient_id) REFERENCES patient(patient_id) ON DELETE CASCADE,
    FOREIGN KEY (doctor_id) REFERENCES doctor(doctor_id) ON DELETE RESTRICT,
    FOREIGN KEY (service_id) REFERENCES service(service_id) ON DELETE RESTRICT
);

-- Таблица платежей
CREATE TABLE payment (
    payment_id INTEGER PRIMARY KEY DEFAULT nextval('payment_id_seq'),
    appointment_id INTEGER NOT NULL UNIQUE,
    receipt_number VARCHAR(50) UNIQUE NOT NULL,
    data DATE NOT NULL,
    payment_status VARCHAR(20) CHECK (payment_status IN ('Оплачен', 'Ожидает', 'Отменен')),
    FOREIGN KEY (appointment_id) REFERENCES appointment(appointment_id) ON DELETE CASCADE
);
